<input type="hidden" name="attr_load_version" value="0.21">
<input type="hidden" name="attr_sheet_version">
<input type="hidden" class="sheet-tabstoggle" name="attr_sheet_tab" value="character" />

<div>
    <button type="action" name="act_character">Character</button>
    <button type="action" name="act_gear">Gear</button>
    <button type="action" name="act_admin">Admin/Settings</button>
</div>

<div class="sheet-character">
    <div class="background">
        <div class="char-image">
            <img class="portrait" name="attr_character_avatar">
            <div>
                <h3>Pilot Image</h3>
            </div>
        </div>
        <div class="background-info">
            <div class="background-info-upper">
                <div class="info-upper-row">
                    <div class="info-upper-row1">Name: <input type="text" class="infoused" name="attr_character_name"
                            value=""></div>
                    <div class="info-upper-row1">Geneotype: <input type="text" class="infoused" name="attr_geneotype"
                            value=""></div>
                    <div class="info-upper-row1">Gender: <input type="text" class="infoused" name="attr_gender"
                            value="">
                    </div>
                </div>
                <div class="info-upper-row">
                    <div class="info-upper-row1" style="width: fit-content;">
                        Callsign: <input type="text" name="attr_callsign" value="">
                    </div>
                    <div class="info-upper-row1" style="width:  fit-content;">
                        Age: <input type="text" class="digit" name="attr_age" value=""></div>
                    <div class="info-upper-row1" style="width: fit-content;">
                        National Origin: <input type="text" class="" name="attr_national_origin" value="">
                    </div>
                </div>
            </div>
            <div class="background-infolower">
                <div class="infobox">
                    <h3>Lifepath & Motivation</h3>
                    <div>
                        <textarea class="inputarea" name="attr_lifepath"></textarea>
                    </div>
                </div>
                <div class="infobox">
                    <h3>Description</h3>
                    <div>
                        <textarea class="inputarea" name="attr_description"></textarea>
                    </div>
                </div>
                <div class="infobox">
                    <h3>Contacts</h3>
                    <fieldset class="repeating_contacts">
                        <input type="text" class="infoused" name="attr_contact_name">
                        <span class="pull-right">
                            Used:<input type="checkbox" name="attr_contact_exhausted">
                        </span>
                        i:<input type="checkbox" name="attr_contact_hide" class="sheet-toggle-show">
                        <div class="sheet-body">
                            <textarea class="inputarea" name="attr_contact_desc"></textarea>
                        </div>
                        </span>
                    </fieldset>
                </div>
            </div>
        </div>
    </div>
    <div class="attributes">
        <div class="damage-box">
            <h3>Damage Results</h3>
            <div>
                Total:<span type="number" name="attr_damage_total" value="0"> </span>
                Shell:<span type="number" name="attr_damage_shell" value="0"></span>
                System:<span type="number" name="attr_damage_system" value="0"></span>
            </div>

            <h4> Damage</h4>
            <fieldset class="repeating_damage">
                <input type="text" name="attr_damage_name" class="infoused">
                -<input type="number" class="digit" name="attr_damage_level" value="0" min="0" max="4">d6
                <div>
                    <span>(<input type="checkbox" name="attr_damage_shell_check"> shell
                        <input type="checkbox" name="attr_damage_system_check"> system) </span>
                    i:<input type="checkbox" name="attr_damage_info" class="sheet-toggle-show" />
                    <div class="sheet-body">
                        Effect:<textarea name="attr_damage_effect" class="inputarea"></textarea>
                        Deterioration:<textarea name="attr_damage_deterioration" class="inputarea"></textarea>
                        Fix:<textarea name="attr_damage_fix" class="inputarea"></textarea>
                    </div>
                </div>
            </fieldset>
            <h4>Damage Notes</h4> <textarea class="inputarea" name="attr_damage_desc" rows="3"></textarea>
        </div>
        <div class="attributes-box">
            <div class="attributes-box-rows">
                <div class="infobox">
                    <h3>Aptitudes</h3>
                    <div>
                        <fieldset class="repeating_aptitudes">
                            <input type="text" class="used" name="attr_aptitudes_name">
                            <input type="checkbox" name="attr_aptitudes_used">
                        </fieldset>
                    </div>
                </div>
                <div class="infobox">
                    <h3>Quirks</h3>
                    <div>
                        <fieldset class="repeating_quirks">
                            <input type="text" class="used" name="attr_quirks_name">
                            <input type="checkbox" name="attr_quirks_used">
                        </fieldset>
                    </div>
                </div>
                <div class="infobox">
                    <h3>Adversities</h3>
                    <div>
                        <fieldset class="repeating_adversities">
                            <input type="text" class="used" name="attr_adversities_name">
                            <input type="checkbox" name="attr_adversities_used">
                        </fieldset>
                    </div>
                </div>
            </div>
            <div class="attributes-box-rows">
                <div class="infobox">
                    <h3>Perks</h3>
                    <div>
                        <fieldset class="repeating_perks">
                            <input class="lvinfoused" type="text" name="attr_perks_name">
                            <input type="number" name="attr_perk_lvl" class="digit" value="0" min="0" max="">
                            <span class="pull-right">
                                Used: <input type="checkbox" name="attr_perk_used">
                            </span>
                            i:<input type="checkbox" name="attr_perk_hide" class="sheet-toggle-show">
                            <div class="sheet-body">
                                <textarea class="inputarea" name="attr_perk_desc"> </textarea>
                            </div>
                        </fieldset>
                    </div>
                </div>

                <div class="infobox">
                    <h3>Flaws</h3>
                    <fieldset class="repeating_flaws">
                        <input type="text" class="lvinfoused" name="attr_flaws_name">
                        <input type="number" name="attr_flaws_lvl" class="digit" value="0" min="0" max="">
                        <span class="pull-right">
                            Used: <input type="checkbox" name="attr_flaws_used">
                        </span>
                        i:<input type="checkbox" name="attr_flaws_hide" class="sheet-toggle-show">
                        <div class="sheet-body">
                            <textarea class="inputarea" name="attr_flaws_desc"> </textarea>
                        </div>
                    </fieldset>
                </div>
            </div>
        </div>

    </div>
    <div class="play-info">
        <div class="inventory">
            <div class="infobox">
                <h3>Personal Inventory</h3>
                <span>Total Burden
                    <span class="pull-right">
                        <span type="number" name="attr_burden_total" value="0"></span>/
                        <input class="digit" type="number" name="attr_burden_total_max" value="8">
                    </span></span>
                <div class="infobox">
                    <h4> <label for="equipment" name="attr_personal_equipment_hide">Equipment.</label> <input
                            type="checkbox" id="equipment" name="attr_personal_equipment_hide" class="sheet-toggle-show"
                            hidden>
                        <span class="pull-right">Burden</span>
                    </h4>
                    <input name="attr_personal_equipment_burden_total" type="number" hidden />
                    <fieldset class="repeating_personal-equipment">
                        <div>
                            <span><input class="infoused" name="attr_personal_equipment_name" type="text"> </span>
                            <span class="pull-right">
                                <input type="number" name="attr_personal_equipment_burden" step="0.25" />
                            </span>
                            <input type="checkbox" name="attr_personal_equipment_hide" class="sheet-toggle-show">

                            <div class="sheet-body">
                                [G] <input type="checkbox" name="attr_personal_equipment_gadget" />
                                [K] <input type="checkbox" name="attr_personal_equipment_kit" />
                                [R] <input type="checkbox" name="attr_personal_equipment_rig" />
                                [S] <input type="checkbox" name="attr_personal_equipment_suit" />
                                Modifiers: <input class="infoused" type="text"
                                    name="attr_personal_equipment_modifiers" />
                                PL:<input name="attr_personal_equipment_pl" type="number">
                                <h5>Notes</h5> <textarea class="inputarea"
                                    name="attr_personal_equipment_desc"></textarea>
                            </div>
                        </div>
                    </fieldset>
                    <input type="checkbox" name="attr_personal_equipment_hide" class="sheet-toggle-show" hidden>
                    <div class="sheet-body">
                        <textarea name="attr_inventory_text" class="inputarea"></textarea>
                    </div>
                </div>
                <h4>Weapons <span class="pull-right">Ammo</span></h4>
                <input name="attr_weapon_burden_total" type="number" value="0" hidden />
                <fieldset class="repeating_weapon">
                    <div><span name="attr_weapon_size"></span>
                        <span>
                            <input type="checkbox" name="attr_weapon_frame_check" class="frame-check" hidden>
                            <span class="no-frame" name="attr_weapon_name">
                            </span>
                            <span class="frame" name="attr_frame_weapon_type"></span>
                            i:<input type="checkbox" name="attr_weapon_hide" class="sheet-toggle-show">
                        </span>
                        <span class="pull-right"> <input type="number" class="digit" name="attr_weapon_ammo">/<span
                                name="attr_weapon_ammo_max"></span></span>
                        <button type="action" name="act_tumble">roll</button>
                    </div>

                    <input type="checkbox" name="attr_weapon_hide" class="sheet-toggle-show" hidden>


                    <div class="sheet-body">
                        <span class="pull-right">Burden: <input class="" type="number" name="attr_weapon_burden"
                                step="0.25"></span>
                        <select name="attr_weapon_size" class="size">
                            <option value="Light" selected>Light</option>
                            <option value="Medium">Medium</option>
                            <option value="Heavy">Heavy</option>
                        </select>
                        <input type="checkbox" name="attr_weapon_frame_check" class="frame-check" hidden>
                        <span class="no-frame"> <input class="infoused" type="text" name="attr_weapon_name"
                                value="weapon">
                        </span>
                        <span class="frame">
                            <select name="attr_frame_weapon_type" class="size">
                                <option value="Assault Rifle">Assault Rifle</option>
                                <option value="Auto Shotgun">Auto Shotgun</option>
                                <option value="Carbine">Carbine</option>
                                <option value="Heavy Rifle">Heavy Rifle</option>
                                <option value="Machine Pistol">Machine Pistol</option>
                                <option value="Pistol/Revolver">Pistol/Revolver</option>
                                <option value="Shotgun">Shotgun</option>
                                <option value="Sniper Rifle">Sniper Rifle</option>
                            </select>
                        </span>
                        Range: <input class="infoused" type="text" name="attr_weapon_range">
                        Damage: <input type="number" name="attr_weapon_damage">
                        Frame: <input type="checkbox" name="attr_weapon_frame_check" class="frame-check">
                        <div>Traits: <input class="infoused" type="text" name="attr_weapon_trait"></div>

                        Ammo ( <input type="number" name="attr_weapon_ammo" class="digit">/
                        <input type="number" name="attr_weapon_ammo_max" class="digit" value="0"> )
                        PL: <input type="number" name="attr_weapon_pl" class="digit">
                        Cumbersome: <input type="checkbox" name="attr_weapon_cumbersome">
                        <span>
                            <select name="attr_weapon_domain">
                                <option value="athletics">Athletics</option>
                                <option value="awareness">Awareness</option>
                                <option value="business">Business</option>
                                <option value="craft">Craft</option>
                                <option value="culture">Culture</option>
                                <option value="electronicwarfare">Electronic Warfare</option>
                                <option value="electronics">Electronics</option>
                                <option value="gunnery">Gunnery</option>
                                <option value="hardscience">Hardscience</option>
                                <option value="influence">Influence</option>
                                <option value="institutions">Institutions</option>
                                <option value="investigation">Investigation</option>
                                <option value="mechanics">Mechanics</option>
                                <option value="medicine">Medicine</option>
                                <option value="melee">Melee</option>
                                <option value="pilot">Pilot</option>
                                <option value="showmanship">Showmanship</option>
                                <option value="socialscience">Socialscience</option>
                                <option value="survival">Survival</option>
                                <option value="tactics">Tactics</option>
                            </select> </span>
                        <span>Skill:<input type="number" name="attr_skill_level" class="digit" value="0" min="0"
                                max="5">(<input type="checkbox" name="attr_skill_familiar" value="1">F)
                            Expertise: <span type="number" name="attr_weapon_expertise">
                            </span>
                            Notes:<textarea class="inputarea" name="attr_weapon_mods"> </textarea>


                    </div>
                    </span>
                </fieldset>
                <h4> Armour</h4>
                <span>Toughness <input type="number" name="attr_toughness" value="2" style="width: 2em;"> Armour <input
                        type="number" name="attr_armour" value="0" style="width: 2em;"> </span>
                <textarea name="attr_armour_desc" class="inputarea" rows="3"></textarea>
            </div>
        </div>
        <div class="skills-misc">
            <input type="checkbox" class="archetype-toggle" name="attr_optional_archetype" hidden />
            <div class="archetype">
                <h3>Archetype</h3>
                <h4> <input type="text" class="" list="archetypelist" name="attr_archetype" value=""
                        style="text-align: center;"><input type="text" name="attr_archetype_rank_letter" value="E"
                        class="digit">-
                    <input type="number" class="digit" min="0" name="attr_archetype_rank" value="0">
                </h4>

                <span>Equipment:<input type="text" name="attr_archetype_equipment" class="infoused" /> </span>
                <div>
                    Resource:<input type="text" class="infoused" name="attr_archetype_resource_name">
                    <input type="number" name="attr_archetype_resource">/<input type="number"
                        name="attr_archetype_resource_max"> Regain <input type="text"
                        name="attr_archetype_resource_regain">
                </div>
                Rules:<fieldset class="repeating_archetype-rules">
                    <input type="text" name="attr_archetype_rules_level">
                    Info: <input type="checkbox" name="attr_archetype_rules" class="sheet-toggle-show">
                    <div class="sheet-body">
                        <textarea class="inputarea" name="attr_archetype_rules_effect"></textarea>
                    </div>
                </fieldset>
            </div>
            <div class="skills">
                <h3>Skills</h3>
                <h4> Bonus Dice: <input type="number" name="attr_bonus_dice" value="0">
                    TN: <input type="number" name="attr_tn" value="5">
                    Reliable: <input type="number" name="attr_reliable" value="0">
                    <input type="number" name="attr_tn_bonus" value="0" hidden>
                </h4>

                <div> Athletics :
                    <input type="hidden" name="attr_name_athletics" value="Athletics">
                    <input class="sheet-domains" type="hidden" name="attr_expertise_athletics" value="0">
                    <span class="sheet-domains-0">
                        Expertise: <span type="number" name="attr_expertise_athletics"></span>
                        (Total Skills:<span name="attr_domain_expertise_athletics" value="0"></span>/6)
                    </span>
                    <span class="sheet-domains-1">
                        Expertise: <span type="number" name="attr_expertise_athletics"> </span>
                        Reroll <input type="checkbox" name="attr_expertise_athletics_used">
                        (Total Skills:<span type="number" name="attr_domain_expertise_athletics" value="">
                        </span>/9)</span>
                    <span class="sheet-domains-2">
                        Expertise: <span type="number" name="attr_expertise_athletics"> </span>
                        Reroll: <input type="checkbox" name="attr_expertise_athletics_used">
                        Doubles. (Total Skills:<span type="number" name="attr_domain_expertise_athletics"></span>/13)
                    </span>
                    <span class="sheet-domains-3">
                        Expertise: <span type="number" name="attr_expertise_athletics"> </span>
                        Reroll: <input type="checkbox" name="attr_expertise_athletics_used">
                        Doubles. TB:1
                    </span>
                    <fieldset class="repeating_skills-athletics">
                        <input type="text" name="attr_skill_domain" value="athletics" hidden>
                        <input type="text" name="attr_skill_name" value="">
                        (<input type="checkbox" name="attr_skill_familiar" value="1">F)
                        <button type="action" name="act_tumble">Roll</button>
                        Level: <input type="number" name="attr_skill_level" value="0" min="0" max="5">
                        XP:<input type="number" name="attr_skill_xp_stored" value="0">
                        <input type="checkbox" name="attr_skill_xp" value="1">
                    </fieldset>
                </div>
                <div> Awareness :
                    <input type="hidden" name="attr_name_awareness" value="Awareness">
                    <input class="sheet-domains" type="hidden" name="attr_expertise_awareness" value="0">
                    <span class="sheet-domains-0">
                        Expertise: <span type="number" name="attr_expertise_awareness" value=""> </span>
                        (Total Skills:<span type="number" name="attr_domain_expertise_awareness" value="0"> </span>
                        /6)
                    </span>
                    <span class="sheet-domains-1">
                        Expertise: <span type="number" name="attr_expertise_awareness"> </span>
                        Reroll <input type="checkbox" name="attr_expertise_awareness_used">
                        (Total Skills:<span type="number" name="attr_domain_expertise_awareness"></span>/9)
                    </span>
                    <span class="sheet-domains-2">
                        Expertise: <span type="number" name="attr_expertise_awareness"> </span>
                        Reroll: <input type="checkbox" name="attr_expertise_awareness_used">
                        Doubles. (Total Skills:<span type="number" name="attr_domain_expertise_awareness"></span>/13)
                    </span>
                    <span class="sheet-domains-3">
                        Expertise: <span type="number" name="attr_expertise_awareness"> </span>
                        Reroll: <input type="checkbox" name="attr_expertise_awareness_used">
                        Doubles. TB:1
                    </span>
                    <fieldset class="repeating_skills-awareness">
                        <input type="text" name="attr_skill_domain" value="awareness" hidden>
                        <input type="text" name="attr_skill_name" value="">
                        (<input type="checkbox" name="attr_skill_familiar" value="1">F)
                        <button type="action" name="act_tumble">Roll</button>
                        Level: <input type="number" name="attr_skill_level" value="0" min="0" max="5">
                        XP:<input type="number" name="attr_skill_xp_stored" value="0">
                        <input type="checkbox" name="attr_skill_xp" value="1">
                    </fieldset>
                </div>

                <div> Business :
                    <input type="text" name="attr_name_business" value="Business" hidden>
                    <input class="sheet-domains" type="hidden" name="attr_expertise_business" value="0">
                    <span class="sheet-domains-0">
                        Expertise: <span type="number" name="attr_expertise_business" value=""> </span>
                        (Total Skills:<span type="number" name="attr_domain_expertise_business" value="0"> </span>
                        /6)
                    </span>
                    <span class="sheet-domains-1">
                        Expertise: <span type="number" name="attr_expertise_business"> </span>
                        Reroll <input type="checkbox" name="attr_expertise_business_used">
                        (Total Skills:<span type="number" name="attr_domain_expertise_business"></span>/9)
                    </span>
                    <span class="sheet-domains-2">
                        Expertise: <span type="number" name="attr_expertise_business"> </span>
                        Reroll: <input type="checkbox" name="attr_expertise_business_used">
                        Doubles. (Total Skills:<span type="number" name="attr_domain_expertise_business">/13) </span>
                    </span>
                    <span class="sheet-domains-3">
                        Expertise: <span type="number" name="attr_expertise_business"> </span>
                        Reroll: <input type="checkbox" name="attr_expertise_business_used">
                        Doubles. TB:1
                    </span>
                    <fieldset class="repeating_skills-business">
                        <input type="text" name="attr_skill_domain" value="business" hidden>
                        <input type="text" name="attr_skill_name" value="">
                        (<input type="checkbox" name="attr_skill_familiar" value="1">F)
                        <button type="action" name="act_tumble">Roll</button>
                        Level: <input type="number" name="attr_skill_level" value="0" min="0" max="5">
                        XP:<input type="number" name="attr_skill_xp_stored" value="0">
                        <input type="checkbox" name="attr_skill_xp" value="1">
                    </fieldset>
                </div>

                <div> Craft :
                    <input type="text" name="attr_name_craft" value="Craft" hidden>
                    <input class="sheet-domains" type="hidden" name="attr_expertise_craft" value="0">
                    <span class="sheet-domains-0">
                        Expertise: <span type="number" name="attr_expertise_craft" value=""> </span>
                        (Total Skills:<span type="number" name="attr_domain_expertise_craft" value="0"> </span>
                        /6)
                    </span>
                    <span class="sheet-domains-1">
                        Expertise: <span type="number" name="attr_expertise_craft"> </span>
                        Reroll <input type="checkbox" name="attr_expertise_craft_used">
                        (Total Skills:<span type="number" name="attr_domain_expertise_craft" value=""> </span>/9)</span>
                    <span class="sheet-domains-2">
                        Expertise: <span type="number" name="attr_expertise_craft"> </span>
                        Reroll: <input type="checkbox" name="attr_expertise_craft_used">
                        Doubles. (Total Skills:<span type="number" name="attr_domain_expertise_craft" value="">
                        </span>/13)
                    </span>
                    <span class="sheet-domains-3">
                        Expertise: <span type="number" name="attr_expertise_craft"> </span>
                        Reroll: <input type="checkbox" name="attr_expertise_craft_used">
                        Doubles. TB:1
                    </span>
                    <fieldset class="repeating_skills-craft">
                        <input type="text" name="attr_skill_domain" value="craft" hidden>
                        <input type="text" name="attr_skill_name" value="">
                        (<input type="checkbox" name="attr_skill_familiar" value="1">F)
                        <button type="action" name="act_tumble">Roll</button>
                        Level: <input type="number" name="attr_skill_level" value="0" min="0" max="5">
                        XP:<input type="number" name="attr_skill_xp_stored" value="0">
                        <input type="checkbox" name="attr_skill_xp" value="1">
                    </fieldset>
                </div>

                <div> Culture :
                    <input type="text" name="attr_name_culture" value="Culture" hidden>
                    <input class="sheet-domains" type="hidden" name="attr_expertise_culture" value="0">
                    <span class="sheet-domains-0">
                        Expertise: <span type="number" name="attr_expertise_culture" value=""> </span>
                        (Total Skills:<span type="number" name="attr_domain_expertise_culture" value="0"> </span>
                        /6)
                    </span>
                    <span class="sheet-domains-1">
                        Expertise: <span type="number" name="attr_expertise_culture"> </span>
                        Reroll <input type="checkbox" name="attr_expertise_culture_used">
                        (Total Skills:<span type="number" name="attr_domain_expertise_culture" value="">
                        </span>/9)</span>
                    <span class="sheet-domains-2">
                        Expertise: <span type="number" name="attr_expertise_culture"> </span>
                        Reroll: <input type="checkbox" name="attr_expertise_culture_used">
                        Doubles. (Total Skills:<span type="number" name="attr_domain_expertise_culture">/13) </span>
                    </span>
                    <span class="sheet-domains-3">
                        Expertise: <span type="number" name="attr_expertise_culture"> </span>
                        Reroll: <input type="checkbox" name="attr_expertise_culture_used">
                        Doubles. TB:1
                    </span>
                    <fieldset class="repeating_skills-culture">
                        <input type="text" name="attr_skill_domain" value="culture" hidden>
                        <input type="text" name="attr_skill_name" value="">
                        (<input type="checkbox" name="attr_skill_familiar" value="1">F)
                        <button type="action" name="act_tumble">Roll</button>
                        Level: <input type="number" name="attr_skill_level" value="0" min="0" max="5">
                        XP:<input type="number" name="attr_skill_xp_stored" value="0">
                        <input type="checkbox" name="attr_skill_xp" value="1">
                    </fieldset>
                </div>

                <div> Electronic Warfare :
                    <input type="text" name="attr_name_electronicwarfare" value="Electronic Warfare" hidden>
                    <input class="sheet-domains" type="hidden" name="attr_expertise_electronicwarfare" value="0">
                    <span class="sheet-domains-0">
                        Expertise: <span type="number" name="attr_expertise_electronicwarfare" value=""> </span>
                        (Total Skills:<span type="number" name="attr_domain_expertise_electronicwarfare" value="">
                        </span>
                        /6)
                    </span>
                    <span class="sheet-domains-1">
                        Expertise: <span type="number" name="attr_expertise_electronicwarfare"> </span>
                        Reroll <input type="checkbox" name="attr_expertise_electronicwarfare_used">
                        (Total Skills:<span type="number" name="attr_domain_expertise_electronicwarfare" value="">
                        </span>/9)</span>
                    <span class="sheet-domains-2">
                        Expertise: <span type="number" name="attr_expertise_electronicwarfare"> </span>
                        Reroll: <input type="checkbox" name="attr_expertise_electronicwarfare_used">
                        Doubles. (Total Skills:<span type="number"
                            name="attr_domain_expertise_electronicwarfare"></span>
                        /13)
                    </span>
                    <span class="sheet-domains-3">
                        Expertise: <span type="number" name="attr_expertise_electronicwarfare"> </span>
                        Reroll: <input type="checkbox" name="attr_expertise_electronicwarfare_used">
                        Doubles. TB:1
                    </span>
                    <fieldset class="repeating_skills-electronicwarfare">
                        <input type="text" name="attr_skill_domain" value="electronicwarfare" hidden>
                        <input type="text" name="attr_skill_name" value="">
                        (<input type="checkbox" name="attr_skill_familiar" value="1">F)
                        <button type="action" name="act_tumble">Roll</button>
                        Level: <input type="number" name="attr_skill_level" value="0" min="0" max="5">
                        XP:<input type="number" name="attr_skill_xp_stored" value="0">
                        <input type="checkbox" name="attr_skill_xp" value="1">
                    </fieldset>
                </div>

                <div> Electronics :
                    <input type="text" name="attr_name_electronics" value="Electronics" hidden>
                    <input class="sheet-domains" type="hidden" name="attr_expertise_electronics" value="0">
                    <span class="sheet-domains-0">
                        Expertise: <span type="number" name="attr_expertise_electronics" value=""> </span>
                        (Total Skills:<span type="number" name="attr_domain_expertise_electronics" value="0"> </span>
                        /6)
                    </span>
                    <span class="sheet-domains-1">
                        Expertise: <span type="number" name="attr_expertise_electronics"> </span>
                        Reroll <input type="checkbox" name="attr_expertise_electronics_used">
                        (Total Skills:<span type="number" name="attr_domain_expertise_electronics"></span>/9)
                    </span>
                    <span class="sheet-domains-2">
                        Expertise: <span type="number" name="attr_expertise_electronics"> </span>
                        Reroll: <input type="checkbox" name="attr_expertise_electronics_used">
                        Doubles. (Total Skills:<span type="number" name="attr_domain_expertise_electronics"></span>/13)
                    </span>
                    <span class="sheet-domains-3">
                        Expertise: <span type="number" name="attr_expertise_electronics"> </span>
                        Reroll: <input type="checkbox" name="attr_expertise_electronics_used">
                        Doubles. TB:1
                    </span>
                    <fieldset class="repeating_skills-electronics">
                        <input type="text" name="attr_skill_domain" value="electronics" hidden>
                        <input type="text" name="attr_skill_name" value="">
                        (<input type="checkbox" name="attr_skill_familiar" value="1">F)
                        <button type="action" name="act_tumble">Roll</button>
                        Level: <input type="number" name="attr_skill_level" value="0" min="0" max="5">
                        XP:<input type="number" name="attr_skill_xp_stored" value="0">
                        <input type="checkbox" name="attr_skill_xp" value="1">
                    </fieldset>
                </div>

                <div> Gunnery :
                    <input type="text" name="attr_name_gunnery" value="Gunnery" hidden>
                    <input class="sheet-domains" type="hidden" name="attr_expertise_gunnery" value="0">
                    <span class="sheet-domains-0">
                        Expertise: <span type="number" name="attr_expertise_gunnery" value=""> </span>
                        (Total Skills:<span type="number" name="attr_domain_expertise_gunnery" value="0"> </span>
                        /6)
                    </span>
                    <span class="sheet-domains-1">
                        Expertise: <span type="number" name="attr_expertise_gunnery"> </span>
                        Reroll <input type="checkbox" name="attr_expertise_gunnery_used">
                        (Total Skills:<span type="number" name="attr_domain_expertise_gunnery" value="">
                        </span>/9)</span>
                    <span class="sheet-domains-2">
                        Expertise: <span type="number" name="attr_expertise_gunnery"> </span>
                        Reroll: <input type="checkbox" name="attr_expertise_gunnery_used">
                        Doubles. (Total Skills:<span type="number" name="attr_domain_expertise_gunnery">/13) </span>
                    </span>
                    <span class="sheet-domains-3">
                        Expertise: <span type="number" name="attr_expertise_gunnery"> </span>
                        Reroll: <input type="checkbox" name="attr_expertise_gunnery_used">
                        Doubles. TB:1
                    </span>
                    <fieldset class="repeating_skills-gunnery">
                        <input type="text" name="attr_skill_domain" value="gunnery" hidden>
                        <input type="text" name="attr_skill_name" value="">
                        (<input type="checkbox" name="attr_skill_familiar" value="1">F)
                        <button type="action" name="act_tumble">Roll</button>
                        Level: <input type="number" name="attr_skill_level" value="0" min="0" max="5">
                        XP:<input type="number" name="attr_skill_xp_stored" value="0">
                        <input type="checkbox" name="attr_skill_xp" value="1">
                    </fieldset>
                </div>

                <div> Hard Science :
                    <input type="text" name="attr_name_hardscience" value="Hard Science" hidden>
                    <input class="sheet-domains" type="hidden" name="attr_expertise_hardscience" value="0">
                    <span class="sheet-domains-0">
                        Expertise: <span type="number" name="attr_expertise_hardscience" value=""> </span>
                        (Total Skills:<span type="number" name="attr_domain_expertise_hardscience" value="0"> </span>
                        /6)
                    </span>
                    <span class="sheet-domains-1">
                        Expertise: <span type="number" name="attr_expertise_hardscience"> </span>
                        Reroll <input type="checkbox" name="attr_expertise_hardscience_used">
                        (Total Skills:<span type="number" name="attr_domain_expertise_hardscience"></span>/9)
                    </span>
                    <span class="sheet-domains-2">
                        Expertise: <span type="number" name="attr_expertise_hardscience"> </span>
                        Reroll: <input type="checkbox" name="attr_expertise_hardscience_used">
                        Doubles. (Total Skills:<span type="number" name="attr_domain_expertise_hardscience"></span>/13)
                    </span>
                    <span class="sheet-domains-3">
                        Expertise: <span type="number" name="attr_expertise_hardscience"> </span>
                        Reroll: <input type="checkbox" name="attr_expertise_hardscience_used">
                        Doubles. TB:1
                    </span>
                    <fieldset class="repeating_skills-hardscience">
                        <input type="text" name="attr_skill_domain" value="hardscience" hidden>
                        <input type="text" name="attr_skill_name" value="">
                        (<input type="checkbox" name="attr_skill_familiar" value="1">F)
                        <button type="action" name="act_tumble">Roll</button>
                        Level: <input type="number" name="attr_skill_level" value="0" min="0" max="5">
                        XP:<input type="number" name="attr_skill_xp_stored" value="0">
                        <input type="checkbox" name="attr_skill_xp" value="1">
                    </fieldset>
                </div>

                <div> Influence :
                    <input type="text" name="attr_name_influence" value="Influence" hidden>
                    <input class="sheet-domains" type="hidden" name="attr_expertise_influence" value="0">
                    <span class="sheet-domains-0">
                        Expertise: <span type="number" name="attr_expertise_influence" value=""> </span>
                        (Total Skills:<span type="number" name="attr_domain_expertise_influence" value="0"> </span>
                        /6)
                    </span>
                    <span class="sheet-domains-1">
                        Expertise: <span type="number" name="attr_expertise_influence"> </span>
                        Reroll <input type="checkbox" name="attr_expertise_influence_used">
                        (Total Skills:<span type="number" name="attr_domain_expertise_influence"></span>/9)
                    </span>
                    <span class="sheet-domains-2">
                        Expertise: <span type="number" name="attr_expertise_influence"> </span>
                        Reroll: <input type="checkbox" name="attr_expertise_influence_used">
                        Doubles. (Total Skills:<span type="number" name="attr_domain_expertise_influence"></span>/13)
                    </span>
                    <span class="sheet-domains-3">
                        Expertise: <span type="number" name="attr_expertise_influence"> </span>
                        Reroll: <input type="checkbox" name="attr_expertise_influence_used">
                        Doubles. TB:1
                    </span>
                    <fieldset class="repeating_skills-influence">
                        <input type="text" name="attr_skill_domain" value="influence" hidden>
                        <input type="text" name="attr_skill_name" value="">
                        (<input type="checkbox" name="attr_skill_familiar" value="1">F)
                        <button type="action" name="act_tumble">Roll</button>
                        Level: <input type="number" name="attr_skill_level" value="0" min="0" max="5">
                        XP:<input type="number" name="attr_skill_xp_stored" value="0">
                        <input type="checkbox" name="attr_skill_xp" value="1">
                    </fieldset>
                </div>

                <div> Institutions :
                    <input type="text" name="attr_name_institutions" value="Institutions" hidden>
                    <input class="sheet-domains" type="hidden" name="attr_expertise_institutions" value="0">
                    <span class="sheet-domains-0">
                        Expertise: <span type="number" name="attr_expertise_institutions" value=""> </span>
                        (Total Skills:<span type="number" name="attr_domain_expertise_institutions" value="0"> </span>
                        /6)
                    </span>
                    <span class="sheet-domains-1">
                        Expertise: <span type="number" name="attr_expertise_institutions"> </span>
                        Reroll <input type="checkbox" name="attr_expertise_institutions_used">
                        (Total Skills:<span type="number" name="attr_domain_expertise_institutions"></span>/9)
                    </span>
                    <span class="sheet-domains-2">
                        Expertise: <span type="number" name="attr_expertise_institutions"> </span>
                        Reroll: <input type="checkbox" name="attr_expertise_institutions_used">
                        Doubles. (Total Skills:<span type="number" name="attr_domain_expertise_institutions"></span>/13)
                    </span>
                    <span class="sheet-domains-3">
                        Expertise: <span type="number" name="attr_expertise_institutions"> </span>
                        Reroll: <input type="checkbox" name="attr_expertise_institutions_used">
                        Doubles. TB:1
                    </span>
                    <fieldset class="repeating_skills-institutions">
                        <input type="text" name="attr_skill_domain" value="institutions" hidden>
                        <input type="text" name="attr_skill_name" value="">
                        (<input type="checkbox" name="attr_skill_familiar" value="1">F)
                        <button type="action" name="act_tumble">Roll</button>
                        Level: <input type="number" name="attr_skill_level" value="0" min="0" max="5">
                        XP:<input type="number" name="attr_skill_xp_stored" value="0">
                        <input type="checkbox" name="attr_skill_xp" value="1">
                    </fieldset>
                </div>

                <div> Investigation :
                    <input type="text" name="attr_name_investigation" value="Investigation" hidden>
                    <input class="sheet-domains" type="hidden" name="attr_expertise_investigation" value="0">
                    <span class="sheet-domains-0">
                        Expertise: <span type="number" name="attr_expertise_investigation" value=""> </span>
                        (Total Skills:<span type="number" name="attr_domain_expertise_investigation" value="0"> </span>
                        /6)
                    </span>
                    <span class="sheet-domains-1">
                        Expertise: <span type="number" name="attr_expertise_investigation"> </span>
                        Reroll <input type="checkbox" name="attr_expertise_investigation_used">
                        (Total Skills:<span type="number" name="attr_domain_expertise_investigation" value=""></span>/9)
                    </span>
                    <span class="sheet-domains-2">
                        Expertise: <span type="number" name="attr_expertise_investigation"> </span>
                        Reroll: <input type="checkbox" name="attr_expertise_investigation_used">
                        Doubles. (Total Skills:<span type="number"
                            name="attr_domain_expertise_investigation"></span>/13)
                    </span>
                    <span class="sheet-domains-3">
                        Expertise: <span type="number" name="attr_expertise_investigation"> </span>
                        Reroll: <input type="checkbox" name="attr_expertise_investigation_used">
                        Doubles. TB:1
                    </span>
                    <fieldset class="repeating_skills-investigation">
                        <input type="text" name="attr_skill_domain" value="investigation" hidden>
                        <input type="text" name="attr_skill_name" value="">
                        (<input type="checkbox" name="attr_skill_familiar" value="1">F)
                        <button type="action" name="act_tumble">Roll</button>
                        Level: <input type="number" name="attr_skill_level" value="0" min="0" max="5">
                        XP:<input type="number" name="attr_skill_xp_stored" value="0">
                        <input type="checkbox" name="attr_skill_xp" value="1">
                    </fieldset>
                </div>

                <div> Mechanics :
                    <input type="text" name="attr_name_mechanics" value="Mechanics" hidden>
                    <input class="sheet-domains" type="hidden" name="attr_expertise_mechanics" value="0">
                    <span class="sheet-domains-0">
                        Expertise: <span type="number" name="attr_expertise_mechanics" value=""> </span>
                        (Total Skills:<span type="number" name="attr_domain_expertise_mechanics" value="0"> </span>
                        /6)
                    </span>
                    <span class="sheet-domains-1">
                        Expertise: <span type="number" name="attr_expertise_mechanics"> </span>
                        Reroll <input type="checkbox" name="attr_expertise_mechanics_used">
                        (Total Skills:<span type="number" name="attr_domain_expertise_mechanics"></span>/9)
                    </span>
                    <span class="sheet-domains-2">
                        Expertise: <span type="number" name="attr_expertise_mechanics"> </span>
                        Reroll: <input type="checkbox" name="attr_expertise_mechanics_used">
                        Doubles. (Total Skills:<span type="number" name="attr_domain_expertise_mechanics"></span>/13)
                    </span>
                    <span class="sheet-domains-3">
                        Expertise: <span type="number" name="attr_expertise_mechanics"> </span>
                        Reroll: <input type="checkbox" name="attr_expertise_mechanics_used">
                        Doubles. TB:1
                    </span>
                    <fieldset class="repeating_skills-mechanics">
                        <input type="text" name="attr_skill_domain" value="mechanics" hidden>
                        <input type="text" name="attr_skill_name" value="">
                        (<input type="checkbox" name="attr_skill_familiar" value="1">F)
                        <button type="action" name="act_tumble">Roll</button>
                        Level: <input type="number" name="attr_skill_level" value="0" min="0" max="5">
                        XP:<input type="number" name="attr_skill_xp_stored" value="0">
                        <input type="checkbox" name="attr_skill_xp" value="1">
                    </fieldset>
                </div>

                <div> Medicine :
                    <input type="text" name="attr_name_medicine" value="Medicine" hidden>
                    <input class="sheet-domains" type="hidden" name="attr_expertise_medicine" value="0">
                    <span class="sheet-domains-0">
                        Expertise: <span type="number" name="attr_expertise_medicine" value=""> </span>
                        (Total Skills:<span type="number" name="attr_domain_expertise_medicine" value="0"> </span>
                        /6)
                    </span>
                    <span class="sheet-domains-1">
                        Expertise: <span type="number" name="attr_expertise_medicine"> </span>
                        Reroll <input type="checkbox" name="attr_expertise_medicine_used">
                        (Total Skills:<span type="number" name="attr_domain_expertise_medicine"></span>/9)
                    </span>
                    <span class="sheet-domains-2">
                        Expertise: <span type="number" name="attr_expertise_medicine"> </span>
                        Reroll: <input type="checkbox" name="attr_expertise_medicine_used">
                        Doubles. (Total Skills:<span type="number" name="attr_domain_expertise_medicine">/13) </span>
                    </span>
                    <span class="sheet-domains-3">
                        Expertise: <span type="number" name="attr_expertise_medicine"> </span>
                        Reroll: <input type="checkbox" name="attr_expertise_medicine_used">
                        Doubles. TB:1
                    </span>
                    <fieldset class="repeating_skills-medicine">
                        <input type="text" name="attr_skill_domain" value="medicine" hidden>
                        <input type="text" name="attr_skill_name" value="">
                        (<input type="checkbox" name="attr_skill_familiar" value="1">F)
                        <button type="action" name="act_tumble">Roll</button>
                        Level: <input type="number" name="attr_skill_level" value="0" min="0" max="5">
                        XP:<input type="number" name="attr_skill_xp_stored" value="0">
                        <input type="checkbox" name="attr_skill_xp" value="1">
                    </fieldset>
                </div>

                <div> Melee :
                    <input type="text" name="attr_name_melee" value="Melee" hidden>
                    <input class="sheet-domains" type="hidden" name="attr_expertise_melee" value="0">
                    <span class="sheet-domains-0">
                        Expertise: <span type="number" name="attr_expertise_melee" value=""> </span>
                        (Total Skills:<span type="number" name="attr_domain_expertise_melee" value="0"> </span>
                        /6)
                    </span>
                    <span class="sheet-domains-1">
                        Expertise: <span type="number" name="attr_expertise_melee"> </span>
                        Reroll <input type="checkbox" name="attr_expertise_melee_used">
                        (Total Skills:<span type="number" name="attr_domain_expertise_melee" value=""> </span>/9)</span>
                    <span class="sheet-domains-2">
                        Expertise: <span type="number" name="attr_expertise_melee"> </span>
                        Reroll: <input type="checkbox" name="attr_expertise_melee_used">
                        Doubles. (Total Skills:<span type="number" name="attr_domain_expertise_melee" value="">
                        </span>/13)
                    </span>
                    <span class="sheet-domains-3">
                        Expertise: <span type="number" name="attr_expertise_melee"> </span>
                        Reroll: <input type="checkbox" name="attr_expertise_melee_used">
                        Doubles. TB:1
                    </span>
                    <fieldset class="repeating_skills-melee">
                        <input type="text" name="attr_skill_domain" value="melee" hidden>
                        <input type="text" name="attr_skill_name" value="">
                        (<input type="checkbox" name="attr_skill_familiar" value="1">F)
                        <button type="action" name="act_tumble">Roll</button>
                        Level: <input type="number" name="attr_skill_level" value="0" min="0" max="5">
                        XP:<input type="number" name="attr_skill_xp_stored" value="0">
                        <input type="checkbox" name="attr_skill_xp" value="1">
                    </fieldset>
                </div>

                <div> Pilot :
                    <input type="text" name="attr_name_pilot" value="Pilot" hidden>
                    <input class="sheet-domains" type="hidden" name="attr_expertise_pilot" value="0">
                    <span class="sheet-domains-0">
                        Expertise: <span type="number" name="attr_expertise_pilot" value=""> </span>
                        (Total Skills:<span type="number" name="attr_domain_expertise_pilot" value="0"> </span>
                        /6)
                    </span>
                    <span class="sheet-domains-1">
                        Expertise: <span type="number" name="attr_expertise_pilot"> </span>
                        Reroll <input type="checkbox" name="attr_expertise_pilot_used">
                        (Total Skills:<span type="number" name="attr_domain_expertise_pilot" value=""> </span>/9)</span>
                    <span class="sheet-domains-2">
                        Expertise: <span type="number" name="attr_expertise_pilot"> </span>
                        Reroll: <input type="checkbox" name="attr_expertise_pilot_used">
                        Doubles. (Total Skills:<span type="number" name="attr_domain_expertise_pilot" value="">
                        </span>/13)
                    </span>
                    <span class="sheet-domains-3">
                        Expertise: <span type="number" name="attr_expertise_pilot"> </span>
                        Reroll: <input type="checkbox" name="attr_expertise_pilot_used">
                        Doubles. TB:1
                    </span>
                    <fieldset class="repeating_skills-pilot">
                        <input type="text" name="attr_skill_domain" value="pilot" hidden>
                        <input type="text" name="attr_skill_name" value="">
                        (<input type="checkbox" name="attr_skill_familiar" value="1">F)
                        <button type="action" name="act_tumble">Roll</button>
                        Level: <input type="number" name="attr_skill_level" value="0" min="0" max="5">
                        XP:<input type="number" name="attr_skill_xp_stored" value="0">
                        <input type="checkbox" name="attr_skill_xp" value="1">
                    </fieldset>
                </div>

                <div> Showmanship :
                    <input type="text" name="attr_name_showmanship" value="Showmanship" hidden>
                    <input class="sheet-domains" type="hidden" name="attr_expertise_showmanship" value="0">
                    <span class="sheet-domains-0">
                        Expertise: <span type="number" name="attr_expertise_showmanship" value=""> </span>
                        (Total Skills:<span type="number" name="attr_domain_expertise_showmanship" value="0"> </span>
                        /6)
                    </span>
                    <span class="sheet-domains-1">
                        Expertise: <span type="number" name="attr_expertise_showmanship"> </span>
                        Reroll <input type="checkbox" name="attr_expertise_showmanship_used">
                        (Total Skills:<span type="number" name="attr_domain_expertise_showmanship"></span>/9)
                    </span>
                    <span class="sheet-domains-2">
                        Expertise: <span type="number" name="attr_expertise_showmanship"> </span>
                        Reroll: <input type="checkbox" name="attr_expertise_showmanship_used">
                        Doubles. (Total Skills:<span type="number" name="attr_domain_expertise_showmanship"></span>/13)
                    </span>
                    <span class="sheet-domains-3">
                        Expertise: <span type="number" name="attr_expertise_showmanship"> </span>
                        Reroll: <input type="checkbox" name="attr_expertise_showmanship_used">
                        Doubles. TB:1
                    </span>
                    <fieldset class="repeating_skills-showmanship">
                        <input type="text" name="attr_skill_domain" value="showmanship" hidden>
                        <input type="text" name="attr_skill_name" value="">
                        (<input type="checkbox" name="attr_skill_familiar" value="1">F)
                        <button type="action" name="act_tumble">Roll</button>
                        Level: <input type="number" name="attr_skill_level" value="0" min="0" max="5">
                        XP:<input type="number" name="attr_skill_xp_stored" value="0">
                        <input type="checkbox" name="attr_skill_xp" value="1">
                    </fieldset>
                </div>

                <div> Social Science :
                    <input type="text" name="attr_name_socialscience" value="Social Science" hidden>
                    <input class="sheet-domains" type="hidden" name="attr_expertise_socialscience" value="0">
                    <span class="sheet-domains-0">
                        Expertise: <span type="number" name="attr_expertise_socialscience" value=""> </span>
                        (Total Skills:<span type="number" name="attr_domain_expertise_socialscience" value="0"> </span>
                        /6)
                    </span>
                    <span class="sheet-domains-1">
                        Expertise: <span type="number" name="attr_expertise_socialscience"> </span>
                        Reroll <input type="checkbox" name="attr_expertise_socialscience_used">
                        (Total Skills:<span type="number" name="attr_domain_expertise_socialscience" value=""></span>/9)
                    </span>
                    <span class="sheet-domains-2">
                        Expertise: <span type="number" name="attr_expertise_socialscience"> </span>
                        Reroll: <input type="checkbox" name="attr_expertise_socialscience_used">
                        Doubles. (Total Skills:<span type="number"
                            name="attr_domain_expertise_socialscience"></span>/13)
                    </span>
                    <span class="sheet-domains-3">
                        Expertise: <span type="number" name="attr_expertise_socialscience"> </span>
                        Reroll: <input type="checkbox" name="attr_expertise_socialscience_used">
                        Doubles. TB:1
                    </span>
                    <fieldset class="repeating_skills-socialscience">
                        <input type="text" name="attr_skill_domain" value="socialscience" hidden>
                        <input type="text" name="attr_skill_name" value="">
                        (<input type="checkbox" name="attr_skill_familiar" value="1">F)
                        <button type="action" name="act_tumble">Roll</button>
                        Level: <input type="number" name="attr_skill_level" value="0" min="0" max="5">
                        XP:<input type="number" name="attr_skill_xp_stored" value="0">
                        <input type="checkbox" name="attr_skill_xp" value="1">
                    </fieldset>
                </div>

                <div> Survival :
                    <input type="text" name="attr_name_survival" value="Survival" hidden>
                    <input class="sheet-domains" type="hidden" name="attr_expertise_survival" value="0">
                    <span class="sheet-domains-0">
                        Expertise: <span type="number" name="attr_expertise_survival" value=""> </span>
                        (Total Skills:<span type="number" name="attr_domain_expertise_survival" value="0"> </span>
                        /6)
                    </span>
                    <span class="sheet-domains-1">
                        Expertise: <span type="number" name="attr_expertise_survival"> </span>
                        Reroll <input type="checkbox" name="attr_expertise_survival_used">
                        (Total Skills:<span type="number" name="attr_domain_expertise_survival"></span>/9)
                    </span>
                    <span class="sheet-domains-2">
                        Expertise: <span type="number" name="attr_expertise_survival"> </span>
                        Reroll: <input type="checkbox" name="attr_expertise_survival_used">
                        Doubles. (Total Skills:<span type="number" name="attr_domain_expertise_survival">/13) </span>
                    </span>
                    <span class="sheet-domains-3">
                        Expertise: <span type="number" name="attr_expertise_survival"> </span>
                        Reroll: <input type="checkbox" name="attr_expertise_survival_used">
                        Doubles. TB:1
                    </span>
                    <fieldset class="repeating_skills-survival">
                        <input type="text" name="attr_skill_domain" value="survival" hidden>
                        <input type="text" name="attr_skill_name" value="">
                        (<input type="checkbox" name="attr_skill_familiar" value="1">F)
                        <button type="action" name="act_tumble">Roll</button>
                        Level: <input type="number" name="attr_skill_level" value="0" min="0" max="5">
                        XP:<input type="number" name="attr_skill_xp_stored" value="0">
                        <input type="checkbox" name="attr_skill_xp" value="1">
                    </fieldset>
                </div>

                <div> Tactics :
                    <input type="text" name="attr_name_tactics" value="Tactics" hidden>
                    <input class="sheet-domains" type="hidden" name="attr_expertise_tactics" value="0">
                    <span class="sheet-domains-0">
                        Expertise: <span type="number" name="attr_expertise_tactics" value=""> </span>
                        (Total Skills:<span type="number" name="attr_domain_expertise_tactics" value="0"> </span>
                        /6)
                    </span>
                    <span class="sheet-domains-1">
                        Expertise: <span type="number" name="attr_expertise_tactics"> </span>
                        Reroll <input type="checkbox" name="attr_expertise_tactics_used">
                        (Total Skills:<span type="number" name="attr_domain_expertise_tactics" value="">
                        </span>/9)</span>
                    <span class="sheet-domains-2">
                        Expertise: <span type="number" name="attr_expertise_tactics"> </span>
                        Reroll: <input type="checkbox" name="attr_expertise_tactics_used">
                        Doubles. (Total Skills:<span type="number" name="attr_domain_expertise_tactics">/13) </span>
                    </span>
                    <span class="sheet-domains-3">
                        Expertise: <span type="number" name="attr_expertise_tactics"> </span>
                        Reroll: <input type="checkbox" name="attr_expertise_tactics_used">
                        Doubles. TB:1
                    </span>
                    <fieldset class="repeating_skills-tactics">
                        <input type="text" name="attr_skill_domain" value="tactics" hidden>
                        <input type="text" name="attr_skill_name" value="">
                        (<input type="checkbox" name="attr_skill_familiar" value="1">F)
                        <button type="action" name="act_tumble">Roll</button>
                        Level: <input type="number" name="attr_skill_level" value="0" min="0" max="5">
                        XP:<input type="number" name="attr_skill_xp_stored" value="0">
                        <input type="checkbox" name="attr_skill_xp" value="1">
                    </fieldset>
                </div>
            </div>
            <div class="infobox">
                <h3>Misc </h3>
                <textarea name="attr_notes_desc" class="inputarea"></textarea>
            </div>
        </div>
    </div>
</div>

<div class="sheet-gear">
    Gear sheet
    <div class="background-info" id="gear1">
        <div>
            Name:<input type="text" name="attr_gear_name">
            Model:<input type="text" name="attr_gear_model">
            PL:<input type="number" name="attr_gearPL">
            TV:<input type="number" name="attr_gear_tv">
        </div>
        <div>
            Actor Type: <input type="text" name="attr_gear_actor_type">
            Height: <input type="number" name="attr_gear_height" step=".5">in
        </div>
        <div>
            Crew:<input type="number" name="attr_gear_crew">
            Movement Rate (MR):<input type="text" name="attr_gear_mr" class="em13">
            Armour (Arm):<input type="number" name="attr_gear_arm">
            Hull Integrity (HI):<input type="number" name="attr_gear_hi" value="0">
        </div>
        <div class="no-buttons">
            <div class="background">
                <h4>TN Bonus: </h4>
                <div class="infobox">
                    <span>Gunnery (GU): <input type="number" name="attr_gear_gunnery_base" class="digit">
                        Total:<span type="number" name="attr_gear_gunnery" class="digit"></span>
                    </span>

                    Skills
                    <fieldset class="repeating_skills-gunnery">
                        <input type="text" name="attr_skill_domain" value="gunnery" hidden>
                        <span type="text" name="attr_skill_name" value=""> </span>
                        <button type="action" name="act_geartumble">Roll</button>
                        Lv:<span type="number" name="attr_skill_level"> </span>
                        XP:<input type="checkbox" name="attr_skill_xp" value="1">
                    </fieldset>
                </div>
                <div class="infobox">
                    <span>Pilot (PI): <input type="number" name="attr_gear_pilot_base" class="digit">
                        Total: <span type="number" name="attr_gear_pilot" class="digit"> </span>
                    </span>
                    Skills:
                    <fieldset class="repeating_skills-pilot">
                        <input type="text" name="attr_skill_domain" value="pilot" hidden>
                        <span type="text" name="attr_skill_name" value=""> </span>
                        <button type="action" name="act_geartumble">Roll</button>
                        Lv:<span type="number" name="attr_skill_level"></span>
                        XP:<input type="checkbox" name="attr_skill_xp" value="1">
                    </fieldset>
                </div>
                <div class="infobox">
                    <span>Electronic Warfare (EW): <input type="number" name="attr_gear_electronicwarfare"
                            class="digit"> Total: <span type="number" name="attr_gear_electronicwarfare"
                            class="digit"></span>
                    </span>
                    Skills
                    <fieldset class="repeating_skills-electronicwarfare">
                        <input type="text" name="attr_skill_domain" value="electronicwarfare" hidden>
                        <span type="text" name="attr_skill_name"></span>
                        <button type="action" name="act_geartumble">Roll</button>
                        Lv:<span type="number" name="attr_skill_level"> </span>
                        XP:<input type="checkbox" name="attr_skill_xp" value="1">
                    </fieldset>
                </div>

            </div>
        </div>



    </div>
    <div class="attributes" id="gear2">
        <div class="damage-box" id="gear2damage">
            <h3> Damage results </h3>
            <span>Hull Integrity(<span type="number" name="attr_gear_damage_total"></span>/<span type="number"
                    name="attr_gear_hi"></span>) </span>
            <div>
                <fieldset class="repeating_gear-damage">
                    <span> <input type="text" class="infoused" name="attr_gear_damage_name">
                        -<input type="number" class="digit" name="attr_gear_damage_level" value="0" min="0"
                            style="width: 2em;">d6
                        <input type="checkbox" name="attr_gear_damage_info" class="sheet-toggle-show" />
                        <div class="sheet-body">
                            Hull Integrity Damage:<input type="checkbox" name="attr_gear_damage_integrity" value="1"
                                checked>
                            Effect:<textarea class="inputarea" name="attr_gear_damage_effect"></textarea>
                            Deterioration:<textarea class="inputarea" name="attr_gear_damage_deterioration"></textarea>
                            Fix:<textarea class="inputarea" name="attr_gear_damage_fix"></textarea>
                        </div>
                    </span>
                </fieldset>

            </div>
            <h4>Gear Damage Notes</h4> <textarea class="inputarea" name="attr_gear_damage_desc" rows="3"></textarea>
        </div>
        <div class="infobox" id="gear2weapons">
            <h3> Weapon Systems </h3>
            <div class="gearweapon-rep">
                <h4>Bonus Dice: <input type="number" name="attr_bonus_dice" value="0">
                    TN: <input type="number" name="attr_tn" value="5">
                    Reliable: <input type="number" name="attr_reliable" value="0">
                </h4>
                <fieldset class="repeating_gearweapon">
                    <span type="text" name="attr_gear_weapon_size"></span>
                    <span type="text" name="attr_gear_weapon_type"></span>
                    <button type="action" name="act_tumble"> roll</button>
                    i:<input type="checkbox" name="attr_gear_weapon_info" class="sheet-toggle-show" />

                    <div class="sheet-body">
                        Size:<select name="attr_gear_weapon_size">
                            <option value="Light">Light</option>
                            <option value="Medium">Medium</option>
                            <option value="Heavy">Heavy</option>
                            <option value=" ">None</option>
                        </select>
                        Type: <input type="text" name="attr_gear_weapon_type" value="Weapon">
                        Code <input type="text" name="attr_gear_weapon_code">
                        Domain:
                        <select name="attr_gear_weapon_domain">
                            <option value="gunnery" selected>Gunnery</option>
                            <option value="pilot">Pilot</option>
                            <option value="electronicwarfare">Electronic Warfare</option>
                        </select>
                        <input type="number" name="attr_gear_weapon_expertise" hidden>
                        Expertise: <span type="number" name="attr_gear_weapon_expertise"></span>
                        TN Bonus: <input type="number" name="attr_gear_weapon_tn_bonus" value="0" hidden>
                        <span type="number" name="attr_gear_weapon_tn_bonus" value="0"> </span>
                        Skill Level:<input type="number" name="attr_gear_skill_level" value="0">
                        (<input type="checkbox" name="attr_gear_weapon_skill_familiar" value="1"> F)
                        <div>
                            Range <input type="number" name="attr_gear_weapon_range_min">-
                            <input type="number" name="attr_gear_weapon_range_med">/<input type="number"
                                name="attr_gear_weapon_range_max">m
                            Blitz Range <input type="number" name="attr_gear_weapon_blitz_range_min">-
                            <input type="number" name="attr_gear_weapon_blitz_range_med">/
                            <input type="number" name="attr_gear_weapon_blitz_range_max">in
                        </div>

                        Damage <input type="number" name="attr_gear_weapon_damage">
                        Category <input type="text" name="attr_gear_weapon_catagory">

                        Traits <input type="text" name="attr_gear_weapon_traits">Ammo (Current<input type="number"
                            name="attr_gear_weapon_ammo_current">
                        /Max <input type="number" name="attr_gear_weapon_ammo_max">)
                        PL <input type="number" name="attr_gear_weapon_pl">
                        Location <input type="text" name="attr_gear_weapon_location">
                        Slots<input type="number" name="attr_gear_weapon_slots">
                        Misc<input type="number" name="attr_gear_weapon_slots_misc">
                        <textarea class="inputarea" name="attr_gear_weapon_notes"></textarea>
                    </div>
                </fieldset>
            </div>
        </div>
    </div>
    <div class="attributes" id="gear3">
        <div class="infobox" id="gear3customization" style="width: 40%;">
            <h3> Customisation </h3>
            <div>
                <h4> Location <span class="pull-right">Slots </span> </h4>
            </div>
            <div> Torso <span class="pull-right"><input type="number" name="attr_slots_torso">/<input type="number"
                        name="attr_slots_torso_max"> </span> </div>
            <div> Right Manip <span class="pull-right"><input type="number" name="attr_slots_l_manip">/<input
                        type="number" name="attr_slotsLManip_max"></span></div>
            <div> Left Manip <span class="pull-right"><input type="number" name="attr_slots_r_manip">/<input
                        type="number" name="attr_slots_r_manip_max"></span></div>
            <div> Right Shoulder <span class="pull-right"><input type="number" name="attr_slots_l_shoulder">/<input
                        type="number" name="attr_slotss_l_shoulder_max"></span></div>
            <div> Left Shoulder <span class="pull-right"><input type="number" name="attr_slots_r_shoulder">/<input
                        type="number" name="attr_slots_r_shoulder_max"></span></div>
            <div class="infobox">
                <h4>Maintainace</h4>
                <span>Type<input name="attr_gear_maintainance_type" type="text" class="infoused"> </span>
                <span>Total: <span name="attr_gear_arm" type="number" class="digit"> </span> hours every
                    <input name="attr_gear_maintainance_cycle" class="digit" type="number" value="7">days </span>
                <span>Remaining:<input name="attr_gear_maintainance_hours" class="digit" type="number"> hours,
                    <input name="attr_gear_maintainance_cycle_remaining" class="digit" type="number" value="7"> days
                </span>
                <span>Current Penalty: <input name="attr_gear_maintainance_penalty" type="number" max="0"> </span>
                Notes:
                <textarea class="inputarea" name="attr_gear_maintainance_desc"></textarea>
                <h4>Repairs</h4> <span> <input name="attr_gear_maintainance_repairs" type="number" class="digit">/
                    <input type="number" name="attr_gear_maintainance_repairs_max" class="digit"> hours </span>
                <textarea class="inputarea" name="attr_gear_maintainance_repairs_desc"></textarea>
            </div>
        </div>
        <div class="infobox" id="gear3traitsequipment">
            <h3> Traits & Equipment </h3>
            <fieldset class="repeating_gear-equipment-traits">
                <div>Name <input type="text" name="attr_gear_equipment_traits_name"> Info: <input type="checkbox"
                        name="attr_geartraithide" class="sheet-toggle-show">
                    <div class="sheet-body">
                        <div>
                            Location <input type="text" name="attr_gear_equipment_traits_location">
                            Slots<input type="number" name="attr_gear_equipment_traits_slots">
                            PL<input type="number" name="attr_gear_equipment_traits_pl">
                        </div>
                        <textarea class="inputarea" name="attr_gear_equipment_traits_desc"></textarea>
                    </div>
                </div>
            </fieldset>
        </div>
    </div>
    <div class="" id="gear4">
        <div class="infobox" id="gear4misc">
            <h3>Misc </h3>
            <textarea class="inputarea" name="attr_gear_desc"></textarea>
        </div>
    </div>
</div>
<div class="sheet-admin">
    <h2> Notes for the GM</h2>
    <textarea name="attr_admin_gmnotes"></textarea>
    Downtime
    <textarea name="attr_admin_downtime"></textarea>
    Optional Rules
    <span>No Archetypes : <input type="checkbox" name="attr_optional_archetype">
    </span>
    <div>
        <h3>Current Issues</h3>
        <p>To be added: Personal Armor list.
        </p>
        <p>Formatting: Gear Weapons. </p>





    </div>
    Version Changes:
    <span>Ver:<span name="attr_load_version"></span> </span>
    0.20 - Roll20 public beta release.
    0.21 - Reliable dice added to roller
    <div>

    </div>
</div>

<datalist id="archetypelist">
    <option value="Caretaker"></option>
    <option value="Commander"></option>
    <option value="Duelist"></option>
    <option value="Fixer"></option>
    <option value="Grunt"></option>
    <option value="Pilot"></option>
    <option value="Scout"></option>
    <option value="Techie"></option>
</datalist>

<datalist id="domainlist">
    <option value="athletics"></option>
    <option value="awareness"></option>
    <option value="business"></option>
    <option value="craft"></option>
    <option value="culture"></option>
    <option value="electronicwarfare"></option>
    <option value="electronics"></option>
    <option value="gunnery"></option>
    <option value="hardscience"></option>
    <option value="institutions"></option>
    <option value="investigation"></option>
    <option value="mechanics"></option>
    <option value="medicine"></option>
    <option value="melee"></option>
    <option value="influence"></option>
    <option value="pilot"></option>
    <option value="showmanship"></option>
    <option value="socialscience"></option>
    <option value="survival"></option>
    <option value="tactics"></option>
</datalist>

<rolltemplate class="sheet-rolltemplate-custom">
    <div class="sheet-container sheet-color-{{color}}">
        <div class="sheet-header">
            {{#title}}<div class="sheet-title">{{title}}</div>{{/title}}
            {{#subtitle}}<div class="sheet-subtitle">{{subtitle}}</div>{{/subtitle}}
        </div>
        <div class="sheet-content">
            {{#allprops() title subtitle desc color}}
            <div class="sheet-key">{{key}}</div>
            <div class="sheet-value">{{value}}</div>
            {{/allprops() title subtitle desc color}}
            {{#desc}}<div class="sheet-desc">{{desc}}</div>{{/desc}}
        </div>
    </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-diceroll">
    <div class="sheet-container sheet-color-{{color}}">
        <div class="sheet-header">
            {{#title}}<div class="sheet-title">{{title}}</div>{{/title}}
            {{#subtitle}}<div class="sheet-subtitle">{{subtitle}}</div>{{/subtitle}}
        </div>
        <div class="sheet-content">
            <span>Score </span>{{computed::roll}}
            <span>MOS </span> {{computed::MOS}}
        </div>
        {{#rollGreater() reliable 0}}
        <div class="sheet-content">
            <span>{{reliable}} Reliable dice</span> <span>
                {{computed::changedone}}|{{computed::changedtwo}}|{{computed::changedthree}}|
                {{computed::changedfour}}|{{computed::changedfive}}|{{computed::changedsix}}</span>
        </div>
        {{/rollGreater() reliable 0}}
        {{#rollLess() reliable 0}}
        <div class="sheet-content">
            <span>{{reliable}}Reliable dice</span> <span>
                {{computed::changedone}}|{{computed::changedtwo}}|{{computed::changedthree}}|
                {{computed::changedfour}}|{{computed::changedfive}}|{{computed::changedsix}}</span>
        </div>
        {{/rollLess() reliable 0}}

        <div class="sheet-content">
            {{#rollGreater() doubles 1}}
            <span>Doubles on</span> <span>{{computed::doubles}} </span>
            {{/rollGreater() doubles 1 }}
        </div>
        <div class="sheet-desc">{{computed::one}}x1s | {{computed::two}}x2s | {{computed::three}}x3s |
            {{computed::four}}x4s | {{computed::five}}x5s | {{computed::six}}x6s
        </div>

</rolltemplate>

<script type="text/worker">
    //top tab buttons code
    const buttonlist = ["character","gear","admin"];
    buttonlist.forEach(button => {
        on(`clicked:${button}`, function() {
            setAttrs({
                sheet_tab: button
            });
        });
    });
    

    const domains = ['athletics','awareness','business','craft','culture','electronicwarfare','electronics','gunnery','hardscience','influence','institutions','investigation','mechanics','medicine','melee','pilot','showmanship','socialscience','survival','tactics'];
    const gearSkills = ['gunnery','pilot','electronicwarfare'];

domains.forEach(function (domains) { //calculates expertise when improving or deleting skills
    on("change:repeating_skills-" + domains + ":skill_level remove:repeating_skills-" + domains + " sheet:opened", function () {
        repeatingSum('domain_expertise_' + domains ,'skills-' + domains, 'skill_level');
    });
});

// Damage Calulations
on('change:repeating_damage remove:repeating_damage sheet:opened', function() { //calculates total damage
	repeatingSum(["damage_shell","damage_system"],"damage",["damage_shell_check","damage_system_check", "damage_level"]);
}); 


on('change:repeating_gear-damage remove:repeating_gear-damage sheet:opened', function() { //calculates gear damage
	repeatingSum("gear_damage_total","gear-damage",["gear_damage_level", "gear_damage_integrity"]);
}); 

//Weapon Domain Calcualtions
on('change:repeating_weapon sheet:opened', function() { //calculates domains to expertise used in personal weapons
    console.log("getting weapon domain");
    getAttrs(["repeating_weapon_weapon_domain"], (values) => {
        console.log("getting weapon domain2");
        let domain = values["repeating_weapon_weapon_domain"];//gets domain name

        getAttrs(["expertise_" + domain], (values) => {
            let expertise = values["expertise_" + domain];//gets expertise value
            console.log(expertise);
            setAttrs({
            repeating_weapon_weapon_expertise:expertise
            });
        });
    });
    //calculate weapon burden
    repeatingSum("weapon_burden_total","weapon",["weapon_burden"]);
}); 
 

on('change:repeating_gearweapon sheet:opened clicked:repeating_gearweapon:tumble', function() { //calculates domains to expertise used in personal weapons
    console.log("getting gear weapon domain");
    getAttrs(["repeating_gearweapon_gear_weapon_domain"], (values) => {
        console.log(values["repeating_gearweapon_gear_weapon_domain"]);
        let domain = values["repeating_gearweapon_gear_weapon_domain"];//gets domain name

        getAttrs(["expertise_" + domain,"gear_"+ domain ], (values) => {
            let expertise = values["expertise_" + domain];//gets expertise value
            let tn_bonus = values["gear_"+ domain];//gets tn bonus value
            console.log(expertise);
            setAttrs({
                repeating_gearweapon_gear_weapon_expertise:expertise
            });
            console.log(tn_bonus);
            setAttrs({
                repeating_gearweapon_gear_weapon_tn_bonus:tn_bonus
            });
        });
    });
}); 



//burden Calculations s

on('change:repeating_personal-equipment sheet:opened', function() { //calculates burden
    console.log("getting personal burden");
    repeatingSum("personal_equipment_burden_total","personal-equipment",["personal_equipment_burden"]);
});

// roll buttons 
domains.forEach(function (domains) { // roll buttons for skill section
    on("clicked:repeating_skills-" + domains + ":tumble", function () {
    roller("repeating_skills-"+domains+"_skill_name","name_"+domains,"repeating_skills-" +domains+"_skill_level","expertise_"+domains,"bonus_dice","Tn","tn_bonus","reliable","repeating_skills-"+domains+"_skill_familiar");

    });
});
gearSkills.forEach(function (gearSkills) { // roll buttons for gear skills
    on("clicked:repeating_skills-"+ gearSkills + ":geartumble", function () {
        roller("repeating_skills-"+gearSkills+"_skill_name","name_"+gearSkills,"repeating_skills-" +gearSkills+"_skill_level","expertise_"+gearSkills,"bonus_dice","Tn","gear_"+gearSkills,"reliable","repeating_skills-"+gearSkills+"_skill_familiar"); 
    });
});


on("clicked:repeating_weapon:tumble", function () { //roll for personal weapons
    roller("repeating_weapon_weapon_name","repeating_weapon_weapon_domain","repeating_weapon_skill_level","repeating_weapon_expertise","bonus_dice","Tn","tn_bonus","reliable","repeating_weapon_skill_familiar");
});

on("clicked:repeating_gearweapon:tumble", function () {//roller for gear weapons
    roller("repeating_gearweapon_gear_weapon_type","repeating_gearweapon_gear_weapon_domain","repeating_gearweapon_gear_skill_level","repeating_gearweapon_gear_weapon_expertise","bonus_dice","Tn","repeating_gearweapon_gear_weapon_tn_bonus","reliable","repeating_gearweapon_gear_weapon_skill_familiar");
});

//


const roller = (getskillname,getdomainname,getskilllevel,getexpertise,getbonus,getTn,getTnBonus,getReliable,getFamilar) => {
    getAttrs([getskillname,getdomainname,getskilllevel,getexpertise,getbonus,getTn,getTnBonus,getReliable,getFamilar], (values) => {
        let skillname = values[getskillname];
        let domain = values[getdomainname];
        let skilllevel = parseInt(values[getskilllevel]);
        let expertise = parseInt(values[getexpertise]);
        let bonus = parseInt(values[getbonus]);
        let Tn = parseInt(values[getTn]);
        let tnBonus = parseInt(values[getTnBonus]);
        tnBonus = tnBonus*-1;//make negative
        let reliable =  parseInt(values[getReliable]);
        let familiar = parseInt(values[getFamilar]);
        reliable = reliable + familiar;//add familiar to reliable dice
        let reliableRoll = Math.abs(reliable);//need to make positive
        Tn = Tn + tnBonus;
        if (expertise == 3){ // expertise 3 TN bonus
            Tn--;
            console.log("TN reduced due to Expertise 3");
        }; 
        if (Tn > 6) { //TN over 6 is converted to bonus dice at 1:2
            bonus = bonus - Math.floor((Tn - 6)/2);
            Tn = 6;
        };
        console.log("skilllevel:"+skilllevel);
        if (skilllevel == 0) {
            bonus--;
            console.log("bonus reduced due to skill level 0",bonus,skilllevel);
        }; 
        // if skillevel+bonus+reliable is less than 1, roll 2d6kl1
        let pooldice = Math.abs(skilllevel + bonus);
        console.log("pooldice:"+pooldice);
        let rolldice = "d6k1";

        if (skilllevel + bonus < 1) {
            console.log("skilllevel + bonus < 1");
            let rolldice = "d6kl1";
        } else {
            let rolldice = "d6k1";  
        };
        console.log(skillname, domain, skilllevel,expertise,bonus,Tn,tnBonus,reliable);
        startRoll("&{template:diceroll} {{title=@{character_name} using "+skillname+"}} {{subtitle= Expertise ("+domain+"):"+expertise+" TN("+Tn+")| Skill="+skilllevel+"+Bonus="+bonus+"(Reliable="+reliable+")}}  {{roll=[[("+pooldice+"+"+reliableRoll+"+1)"+rolldice+"]] }} {{MOS=[[0]]}} {{doubles=[["+expertise+"]]}} {{reliable=[["+reliable+"]]}} {{six=[[6]]}} {{five=[[5]]}} {{four=[[4]]}} {{three=[[3]]}} {{two=[[2]]}} {{one=[[1]]}}  {{changedsix=[[6]]}} {{changedfive=[[5]]}} {{changedfour=[[4]]}} {{changedthree=[[3]]}} {{changedtwo=[[2]]}} {{changedone=[[1]]}}" , (diceroll) => {
            let total = diceroll.results.roll.result;
            let dice = diceroll.results.roll.dice;
            let MOS = 0;
            let doubles = 0;
            const total6s = dice.filter(d => d === 6).length;
            const total5s = dice.filter(d => d === 5).length;
            const total4s = dice.filter(d => d === 4).length;
            const total3s = dice.filter(d => d === 3).length;
            const total2s = dice.filter(d => d === 2).length;
            const total1s = dice.filter(d => d === 1).length;

            const targetArray = [0,total1s,total2s,total3s,total4s,total5s,total6s];
            const reliableArray = [reliable,0,0,0,0,0,0];//records reliable dice
            console.log(targetArray,total);
            let tempArray = targetArray;
            
            //remove x reliable dice
            //if reliable is greater than 1, remove x lowest 
            if (reliableArray[0] > 0) {
                console.log("reliable is greater than 1");
                while (reliableArray[0] > 0) {
                    for (i=1;i<7;i++) {
                        if (tempArray[i] > 0) {
                            tempArray[i]--;
                            reliableArray[i]--;
                            reliableArray[0]--;
                            i = 7;
                        };
                    };
                };
            };

            //if reliable is less than 1, remove x highest
            if (reliableArray[0] < 0) {
                console.log("reliable is less than 1");
                while (reliableArray[0] < 0) {
                    for (i=6;i>0;i--) {
                        if (tempArray[i] > 0) {
                            tempArray[i]--;
                            reliableArray[i]--;
                            reliableArray[0]++;
                            i = 0;
                        };
                    };
                };
            };
            //calculate total
            //if (skilllevel + bonus) is >0 find highest number
            if ((skilllevel + bonus) > 0) { 
                for (i=6;i>0;i--) {
                    if (tempArray[i] > 0) {
                        console.log("calculate high total :"+i);
                        total = i;
                        i = 0;
                    };
                };
            };            
            //if (skilllevel + bonus) is <1 find lowest number
            if ((skilllevel + bonus) < 1) {
                for (i=1;i<7;i++) {
                    if (tempArray[i] > 0) {
                        console.log("calculate low total :"+i);
                        total = i;
                        i = 7;
                    };
            };
        };
            tempArray[total]--;//take out the total from the array

            if (total < Tn) { //TN is bigger, calculate MOF
            } else {  //TN is smaller, calculate MOS
                for (i=Tn;i<=total;i++) {
                    MOS = MOS + tempArray[i];
                };
            };

            if (expertise > 1) {
                for (i=1;i<Tn;i++) {
                    if (tempArray[i] > 1){
                        tempArray[i] = tempArray[i] - 2;
                        doubles = i;
                        total++;
                        i = Tn;
                        
                        console.log("doubles:"+doubles+" added " + tempArray);
                    };
                };
            };
                
                total = total + MOS;
                MOS = total - Tn;
                
                console.log("temp:"+tempArray,"reliable+:"+reliableArray);

            finishRoll(diceroll.rollId, {
                roll: total,
                MOS:    MOS,
                six:    total6s,
                five:   total5s,
                four:   total4s,
                three:  total3s,
                two:    total2s,
                one:    total1s,
                changedsix:    reliableArray[6],
                changedfive:   reliableArray[5],
                changedfour:   reliableArray[4],
                changedthree:  reliableArray[3],
                changedtwo:    reliableArray[2],
                changedone:    reliableArray[1],
                doubles: doubles
            });
        });
    });
};


   /*  ======================================================
            BEGIN MULTIVERSAL SHEET WORKER GENERATOR
    ======================================================
    Use this script to build sheet workers automatically.
    Place this section in your script block, preferably at the end. 
    Fill the two data objects, multistats and multifunctions, with your details.
    VERSION 1.
    READMORE: https://app.roll20.net/forum/permalink/7664925/
    ======================================================*/

const multistats = {
    damage_total: {rule: 'sum', attributes: ['damage_shell','damage_system']},
    burden_total: {rule: 'sum', attributes: ['personal_equipment_burden_total','weapon_burden_total']},
    gear_gunnery: {rule: 'sum', attributes: ['gear_gunnery_base','gear_maintainance_penalty']},
    gear_pilot: {rule: 'sum', attributes: ['gear_pilot_base','gear_maintainance_penalty']},
    gear_electronicwarfare: {rule: 'sum', attributes: ['gear_electronicwarfare_base','gear_maintainance_penalty']},

};
domains.forEach(domains => {
    multistats[`expertise_${domains}`] = {rule: 'calc_expertise', attributes: [`domain_expertise_${domains}`]};
});

const multifunctions = {
    sum: (arr) => arr.reduce((total, add) => total + add),  // add up any number of attributes
    pick_from_list: (arr) => arr[ arr[0] ], // get the value of an attribute, from a select.
    calc_expertise: function(arr) { // calculate expertise based on total skill level
        let expertise = arr[0];
        console.log(expertise);
        if (expertise < 6){
            return 0;
        } else if (expertise < 9) {
            return 1;
        } else if (expertise < 13) {
            return 2;
        } else if (expertise > 12) {
            return 3;
        } else {
            return 0;}
    },

};

// ======================================================*/
//           DO NOT EDIT BELOW THIS LINE                 //
// ======================================================*/
const mvlog = (title, text, color = 'green', style='font-size:12px; font-weight:normal;', headerstyle = 'font-size:13px; font-weight:bold;') => {
    let titleStyle = `color:${color}; ${headerstyle} text-decoration:underline;`;
    let textStyle = `color:${color}; ${style}`;
    const output = `%c${title}:%c ${text}`;
    console.log(output,titleStyle,textStyle);
};
// can use $ placeholder in attribute names. This converts '$_stat' to 'repeating_section_stat'
const rep = '$'; //placeholder for repeating_section_
const makeRepeatingName = (attribute, section) => attribute.startsWith(rep) ? attribute.replace(rep, `repeating_${section}_`) : attribute;
const makeRepeatingAttributes = (attributes, section) => attributes.map(a => makeRepeatingName(a, section));
const makeRepeatingID = (a, section, id) => a.replace(`repeating_${section}_`,`repeating_${section}_${id}_`);
// given array of attributes, find if any have repeating_ and return the section name
// section name will be 2nd element of name split on "_"
const findSection = (arr) => {
    const s = arr.find(a => a.includes('repeating_'));
    const section = (s ? s.split('_')[1] : null);
    return section;
};

// check if attribute is one where a repeating section attribute depends on attributes both inside and outside the repeating section
const isMixed = (attributes, destination) => {
    const some = someRepeating(attributes);
    const all = allRepeating(attributes);
    const repeatingdestination = destination.startsWith('repeating_');
    return (some && !all && repeatingdestination);
};
const allRepeating = attributes => attributes.every(r => r.startsWith('repeating_'));
const someRepeating = attributes => attributes.some(r => r.startsWith('repeating_'));

const defaultDataType = 'array'; // might change this to object
const getData = (values, data = 'a', isnumbers = 0) => {
    // only a is functional right now, so this function is redundant.
    switch(data.charAt(0).toLowerCase()) {
        case 'o': return values;
        case 'a': return Object.values(values).map(i => 1 === isnumbers ? parseInt(i) ||0 : (0 === isnumbers ? +i || 0 : i));
        case 'v': return Object.values(values)[0];
    }
};

const processMax = (destination, result, max) => {
    const settings = {};
    if(max === 'current' || max === 'both') settings[destination] = result;
    if(max === 'max' || max === 'both') settings[`${destination}_max`] = result;
    return settings;
};

const isFunction = value => value && (Object.prototype.toString.call(value) === '[object Function]' || 'function' === typeof value || value instanceof Function);

const processFunction = (destination, values, section) => {
    const rule = multistats[destination].rule;
    const func = isFunction(rule) ? rule:  multifunctions[rule]; // need to test if this works for arrow functions
    const data = multistats[destination].data || defaultDataType;
    const v = getData(values, data);
    const modifier = multistats[destination].modifier || null;
    const result = func(v, modifier);
    mvlog(`${makeRepeatingName(destination,section).toUpperCase()} MULTIFUNCTION`, `RULE: ${rule}; VALUES: ${JSON.stringify(values)}; RESULT: ${result}`);
    return result;
};

Object.keys(multistats).forEach(destination => {
    // get the section name if it exists. It is needed for mixed workers
    const attributes_base = multistats[destination].attributes;
    const section = multistats[destination].section || findSection(attributes_base) || null;
    const attributes = makeRepeatingAttributes(attributes_base, section);
    const realdestination = makeRepeatingName(destination, section); // needed in case of $ in destination
    mvlog(`MULTIVERSAL- ${realdestination}`,`${attributes.join(', ')}`,'green');
    if (isMixed(attributes, realdestination)) {
        const changes = attributes.reduce((change, step) => `${change} change:${step.replace('repeating_' + section + '_','repeating_' +section + ':')}`,
            `remove:repeating_${section} sheet:opened`);
        on(changes.toLowerCase(), function (event) {
            const trigger = event.sourceAttribute || '';
            const triggerRow = (trigger && trigger.includes('_') && trigger.length >2) ? trigger.split('_')[2] : '';
            // if triggerRow, only update initial row
            getSectionIDs(`repeating_${section}`, function (ids) {
                const sectionAtts = attributes.filter(f => f.startsWith(`repeating_${section}`));
                const fixedAtts = attributes.filter(f => !f.startsWith(`repeating_${section}`));
                if (triggerRow) ids = [triggerRow];
                const fieldNames = ids.reduce( (m,id) => [...m, ...(sectionAtts.map(field => makeRepeatingID(field,section,id) ))],[]);
                getAttrs([...fieldNames,...fixedAtts], function (values) {
                    let settings = {};
                    const max = multistats[destination].max || 'current';
                    const fixedValues = fixedAtts.reduce((obj, a) => {
                        obj[a] = values[a];
                        return obj;
                    }, {});
                    ids.forEach(id => {
                        // first get all relevant attributes for this row of the section
                        const sectionValues = sectionAtts.reduce((obj, a) => {
                            const att = makeRepeatingID(a, section, id);
                            obj[att] = values[att]; 
                            return obj;}, {});
                        // now apply the formula for this row and add to settings
                        const combinedValues = {...sectionValues,...fixedValues};
                        const result = processFunction(destination,combinedValues, section);
                        const tempDestination = makeRepeatingID(realdestination,section,id); 
                        const tempSettings = processMax(tempDestination, result, max);
                        settings = Object.assign({}, settings, tempSettings);
                    });
                    setAttrs(settings);
                });
            });
        });
    } else {
        const changes = attributes.reduce((change, step) => `${change} change:${step.replace('repeating_' + section + '_','repeating_' +section + ':')}`,
            `${someRepeating([...attributes,realdestination]) ? '' : 'sheet:opened '}${section ? `remove:repeating_${section}` : ''}`);
        on(changes.toLowerCase(), function () {
            getAttrs(attributes, function (values) {
                const result = processFunction(destination,values, section);
                const max = multistats[destination].max || 'current';
                const settings = processMax(realdestination, result, max);
                setAttrs(settings);
            });
        });
    }
});
/* ===== PARAMETERS ==========
destinations = the name of the attribute that stores the total quantity
section = name of repeating fieldset, without the repeating_
fields = the name of the attribute field to be summed
      can be a single attribute: 'weight'
      or an array of attributes: ['weight','number','equipped']
extras: everything after the fields parameter is optional and can be in any order:
    'ceil'
    'round'
    'floor'
    'ceil: 3'
    'round: -2'
    'round: equipment_weight, equipment_cost|2
        you want to round the final total. 
        If you supply a field name, it will round just that total. You can supply multiple fields, separated by commas.
        If you supply a number, it will round to that many digits. 
        round:1 rounds to tenths; floor:-3 rounds down to thousands, so 3567 would be shown as 3000.
        If you dont supply a number, it assumes 0, and returns an integer (whole numbers).
        IMPORTANT: if you list ANY field, then ALL fields to be rounded must be specifically stated.
        Don't do this: floor:equipment_weight|2, round,
    
    'multiplier: 2'
    'multiplier:equipment_weight|2'
    'multiplier: equipment_weight|2, equipment_cost|3'
        Multiplier will apply a multiple to the final total. You can multiple all fields, or specific fields.
        It doesnt apply to attributes being added from outside the repeating section.
        Multiplier can be negative, representing a subtraction.

    'an_attribute'
    'an_attribute:-1'
    'an_attribute:0.5'
    'an_attribute:equipment_cost'
    'an_attribute:equipment_cost|-1'
    'an_attribute:equipment_cost|-1,equipment_weight|2'
        You can also list attributes from outside the repeating section. Don't try to add attributes from other repeating sections.
        by default, the listed attribute will be added to all fields.
        You can list one or more fields, and it will only be added to those fields.
        You can list a number: the attribute will be multiplied by that amount. So -1 subtracts the attribute.
    */
const repeatingSum = (destinations, section, fields, ...extras) => {
    const isNumber = value => parseFloat(value).toString() === value.toString();
    const isOption = value => [...checks.valid, ...checks.roundtypes].includes(value);
    const isRounding = value => checks.roundtypes.includes(value);
    const isFraction = value => value.includes('/') && !(value.includes(',') || value.includes('|'));
    const getTrimmed = value => value.toLowerCase().replace(/\s/g, '');
    const getRounded = (type, value, pow) => (Math[type](value * Math.pow(10, pow)) / Math.pow(10, pow)).toFixed(Math.max(0, pow));
    const getFraction = (value) => /*{ console.log(`value: ${value}`); */
        parseInt(value.split('/')[0]) / parseInt(value.split('/')[1]);
    const getMultiplier = (value, rounding = 1) => 'undefined' === typeof value ? (rounding ? 0: 1) : (
        isNumber(value) ? parseFloat(value) : (isFraction(value) ? getFraction(value) : value));
    if (!Array.isArray(destinations)) destinations = [getTrimmed(destinations)];
    if (!Array.isArray(fields)) fields = [getTrimmed(fields)];
    const fields_trimmed = fields.map(field => getTrimmed(field).split(':')[0]);
    const subfields = fields_trimmed.slice(0,destinations.length);
    const checks = { valid: ['multiplier'], roundtypes: ['ceil', 'round', 'floor'] };
    let properties = {attributes: {}, options: {}};
    extras.forEach(extra => {
        const [prop, v] = getTrimmed(extra).split(':');
        const multiplier_maybe = getMultiplier(v, isRounding(prop));
        const obj = isNumber(multiplier_maybe) ? subfields.reduce((obj,field) => {
            obj[field] = multiplier_maybe;
            return obj;
        },{}) : multiplier_maybe.split(',').reduce((obj, item) => {
            const [stat, value] = item.split('|');
            const multiplier = getMultiplier(value, isRounding(prop));
            obj[stat] = multiplier;
            return obj;
        }, {});
        properties[isOption(prop) ? 'options' : 'attributes'][prop] = obj;
    });
    getSectionIDs(`repeating_${section}`, idArray => {
        const attrArray = idArray.reduce((m, id) => [...m, ...(fields_trimmed.map(field => `repeating_${section}_${id}_${field}`))], []);
        getAttrs([...attrArray, ...Object.keys(properties.attributes)], v => {
            const getValue = (section, id, field) => v[`repeating_${section}_${id}_${field}`] === 'on' ? 1 : parseFloat(v[`repeating_${section}_${id}_${field}`]) || 0;
            const commonMultipliers = (fields.length <= destinations.length) ? [] : fields.splice(destinations.length, fields.length - destinations.length);
            const output = destinations.reduce((obj, destination, index) => {
                let sumTotal = idArray.reduce((total, id) => total + getValue(section, id, fields_trimmed[index]) * commonMultipliers.reduce((subtotal, mult) => subtotal * ((!mult.includes(':') || mult.split(':')[1].split(',').includes(fields_trimmed[index])) ? getValue(section, id, mult.split(':')[0]) : 1), 1), 0);
                sumTotal *= (properties.options.hasOwnProperty('multiplier') && Object.keys(properties.options.multiplier).includes(fields_trimmed[index])) ? (parseFloat(properties.options.multiplier[fields_trimmed[index]]) || 0): 1;
                sumTotal += Object.entries(properties.attributes).reduce((total, [key, value]) => 
                    total += (value.hasOwnProperty(fields_trimmed[index]) ? parseFloat(v[key] || 0) * (parseFloat(value[fields_trimmed[index]]) || 1): 0) , 0);
                checks.roundtypes.forEach(type => {
                    if (properties.options.hasOwnProperty(type)) {
                        if (Object.keys(properties.options[type]).includes(fields_trimmed[index])) {
                            sumTotal = getRounded(type, sumTotal, (+properties.options[type][fields_trimmed[index]] || 0));
                        } else if (properties.options[type] == '0' || !isNaN(+properties.options[type] || 'x') ) {
                            sumTotal = getRounded(type, sumTotal, +properties.options[type]);
                        } 
                    } 
                });
                obj[destination] = sumTotal;
                return obj;
            }, {});
            setAttrs(output);
            console.log(output); 
        }); 
    }); 
};

</script>